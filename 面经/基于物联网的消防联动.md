# 基于物联网的消防动力设备监测系统

# 主要目的

+ 对动力设备电源状态进行检测，包括设备三相电压 三相电流等。
+ 对风机进行逻辑控制，包括风机的开关、高速低速。控制来源主要分为两部分
  + 第一部分是手动、联动、自动信号的直接控制风机，优先级为从高到低。
  + 另一部分是基于设备电源状态，如果有过压、过流会关掉风机设备。
+ 下位机对上位机的通信和数据的储存。

# 创新点

代码量：5000左右

+ 基于手动、联动、自动信号的逻辑控制。因为这三个信号有一个优先级的问题，所以不能单纯的检测到为高电平信号就开风机，低电平信号就关风机。要结合起来判断。
+ 设备开发的综合性比较高，管脚基本上都用到了用到了主控电路STM32内嵌的很多模块和很多基础的外设，以及RS485通信。工作量其实还蛮大的。

# 硬件

## 主控制器电路

+ 芯片：STM32F103VCT6
+ 256 kBFlash  48 kBRAM
+ 主频：72MHz，芯片外接8MHz无源晶振，通过倍频可以达到72MHz
+ ADC：12位ADC模块，采集频率为50HZ交流电可以采集60个点。
+ DMA
+ 供电电压：DC 3.3V
+ UART:接RS485 9600.
+ TIM
+ 中断
+ 看门狗

## 采样电路

### 采样电压电路

采样电压电路是采集220V交流电50Hz，因为电压较大，首先要进行降压处理，降至单片机接受的3.3V。

降压处理：电压差分放大电路

优点：消除温度等因素对电路产生的影响，提高采样精度

![image-20210629162152909](https://i.loli.net/2021/06/29/257q4JFAPbnHco1.png)

那么电压增益
$$
A_u = \frac{R_2}{R_1}  = \frac{R_4}{R_3}
$$
而且交流信号存在半周期的负值信号，需要添加**直流偏置电压**来抬高负半轴的信号，使其始终处于单片机可以采集的范围。

那么最后的电路图

![image-20210629162651054](https://i.loli.net/2021/06/29/cFJdEL2S3P97CMR.png)
$$
u_i = 220\sqrt{2}sin(wt+\phi)
$$
电压输出表达式
$$
U_o = 1.5 + \frac{8.2}{4000}u_i
$$
那么得到
$$
0.862\leq U_o\leq2.138
$$
电路要记得有两个保护：

+ 后面R+C组成低通滤波电路，防止高次谐波影响采样精度
+ UWV三相要通过电压钳位预防电压过压来保护电路

### 采样电流电路

电流检测：先用电阻转换为电压，然后再进行采样。

![image-20210629163657056](https://i.loli.net/2021/06/29/JfuWgTc2Pry74di.png)
$$
U_{adc} = I_iR_{96}
$$

## 时钟DS1302电路

+ 保证系统断电时仍然能够记录时间，为单片机提供准确时间数据。
+ 准确时间是因为要保存操作记录到Flash，必须要有准确时间

![image-20210629164315204](https://i.loli.net/2021/06/29/sydXSCE5YlZ2Bh3.png)

+ 供电：VCC2由系统供电，VCC1由纽扣电池供电，为备用电源。

+ I2C协议
  + CK- 时钟信号
  + I/O - 数据信号
  + CE - 芯片使能
  + DS1302在上升沿写入，下降沿回送给STM32数据
  
+ 如何向DS1302写时间

  先设置一个u8的数组

  ```
  u8 Time_Buf[8]={0x20,0x21,0x04,0x29,0x14,0x39,0x52,0x04};
  ```

  关闭写保护。

  CE由0->1，开始写入地址。写入一个时间寄存器地址后，再写入对应的时间数据。

  地址就是时间各个部分的寄存器，比如年寄存器、小时寄存器等。年+月+日+时+分+秒+星期，一共7个。

  打开写保护。

+ 如何从DS1302读时间

  从各个时间寄存器地址里读即可。

+ 如何将DS1302读出的时间在LCD上显示

  读取时间后，存到u8的一个数组里，分离出每个时间部分的个位数。(比如年的百、十、个位)，依次显示。

## 继电器输出电路

由于采用的是闭环控制风机电路，所以在发出启动风机信号后，还要有一个反馈信号接入，来确认是否启动成功。

+ 74HC595：串行输入、8位并行输出的位移寄存器。
  + RCK：输出时钟线
  + SCK：输入时钟线
  + DATA：数据

+ ULN2003：输出大电流，驱动大功率。

![image-20210629173349493](https://i.loli.net/2021/06/29/4ljitKZypABCkMo.png)

## 键盘驱动电路

+ 带键盘扫描接口的LED驱动IC，封装形式SOP24

+ 可以读取按键，设置LED亮度等。

+ CLK+STB+输入输出DIO引脚 I2C模式。

+ **STB由1->0，表示DIO为写命令。**

+ TM1639怎么读按键？

  STM32向TM1639发送读按键命令，TM1639开始读按键，并将读到数据经DIO发送到stm32。**没错，是被动读，在主程序中无限循环。**
  
+ 为啥单片机一般用u8，unsigned char

  uint8_t正好是一个字节，即8位，大多情况下与实际元件管脚相对用。

  uint8_t只占一个字节，单片机内存小，省着用。

+ 如何设计3.3V高电平->5V高电平的转换

  ![image-20210721201032906](https://atenquest-typora-picture.oss-cn-beijing.aliyuncs.com/img/image-20210721201032906.png)

## LCD液晶显示电路

+ 128x64
+ 1mA
+ **管脚**：数据指令标志位RS+8位并行输入口DB0-7+片选CSA、CSB+使能EN+读/写WR+重置RS

### LCD实现代码

+ 分成左半部分、右半部分来显示，通过CSA、CSB管脚来更改

+ 判断“忙”方法：向LCD写入指令0x00，读取返回数据，如果**数据返回在DB7位为1，那么就表示LCD为忙**。

+ 如何显示一个字符？

  12864将屏幕分成了8页，每一页包含了8行，每次写入8位的数据就是向某一行写入了8列数据。写入字符char范围为0x20-0x7e，为ASCII码的字符范围(特殊符号+字母+数字)。然后经过查字符点阵表，显示出对于的字符。
  
+ 字符显示效果是什么样？

  有5x8和8x16两种字节格式。

+ 如何显示一个float

  我写了两种方式，第一种基于string，通过`sprintf函数`将float转为string，再以string的形式显示。另一种是直接显示float的函数，分为十位小数(x.x)，百分位小数(xx.x)。**具体做法是将数据扩大至没有小数**，然后一步步计算。

+ LCD的初始化

  RST从1->0。左右屏从关->开。

+ 清屏

  清屏就是从头到尾全部显示空字符就可以了。

  

## 信号接入电路



共有5个外部输入信号；还要一个按键手动信号。

+ 手动信号：电路板直接控制风机的按键

+ 联动信号：火灾探测器发出警报的信号

+ 自动信号：优先级最低的自主选择信号

+ 风机启动反馈信号：反馈风机是否启动

+ 风机速度挡位信号：在启动反馈信号为高电平时，反馈风机是否启动。

  ![image-20210805163106925](https://i.loli.net/2021/08/05/ihfXowgGMRvN2Ox.png)

## 通信电路

+ RS485

  + RS485_TX
  + RS485 RX
  + RS485_DIR,低电平接收(从stm32) 高电平发送(发送出去)

  ![image-20210629180843619](https://i.loli.net/2021/06/29/mnlU9dTbRYsFNHV.png)

+ R32是为了消除长距离传输时信号由于阻抗不匹配引起的反射问题

## 报警系统

蜂鸣器电路

![image-20210721200904245](https://atenquest-typora-picture.oss-cn-beijing.aliyuncs.com/img/image-20210721200904245.png)

## 电源系统

+ 24V：稳压管LM117(AC->DC)

+ 5.0V：LM2596

+ 3.3V：SPX1117

+ 1.5V：AMS1117

  

# 软件

+ 当设备上电后，系统自动完成初始化
  + stm32内部：ADC 、GPIO、串口、定时器、DMA通道、看门狗。
  + 外设：DS1302、LCD、TM1639、74HC595
  + 读取内部Flash的值，用来保存操作和故障记录。
+ 屏幕切换
  + 主屏：显示电压、电流值。显示日期。
  + 副屏：设置风机工作电流、互感器比例、RS485地址

+ 监控
  + 电压：过压、低压、缺相报警
  + 电流：过流报警
  + 报警记录在Flash内部

+ 逻辑控制
  + 手动按键控制
  + 联动、自动信号输入
+ 通信
  + 收到上位机指示(100ms发一次)，向上位机发送采集信息。

## 采样交流电算法

### 多周期等间隔采样法

+ 在m个周期内等间隔采样N个点，当
  $$
  2m/N不为整数
  $$
  采样有效值理论误差为0。

+ 电压 电流均满足

+ 采样频率=3M,每秒采60次

## 信号

+ 手动信号：直接控制风机启动、关闭的按键信号，优先级最高。
+ 联动信号：其他消防设备发出的信号
+ 自动信号：远端消防总控机箱发出的信号。

## 定时TIM

计时器2，0.5s

+ 记录风机的运行时间  
+ 记录蜂鸣器的报警时长

## 中断

+ 外部中断：LCD_mode

+ 串口接收中断

## RS485 通信软件设计

+ RS485总线使用Modbus协议

  > Modbus：
  >
  > + 一个主机，多个从机。
  >+ 每个从机有自己的地址码，只能被动发送
  > + 理论支持从机最多为31个

  波特率设置为9600
  
  码设置：从机地址+功能码+数据位+CRC校验位
  
+ CRC如何校验

  根据输入字节内容和字节长度，使用CRC直接查找表法。基于CRC-16的标准，即每次验证16个字节。

+ CRC16的具体代码法

  ![image-20210721211446729](../../../../../AppData/Roaming/Typora/typora-user-images/image-20210721211446729.png)
  
+ 共发送字节数最大可支持64字节。

## 数据备份

F103内部Flash容量位256K，分为**128页**。

stm32的flash地址起始于0x0800 0000，进行一下重映射。

![image-20210922175520302](C:\Users\atenq\AppData\Roaming\Typora\typora-user-images\image-20210922175520302.png)

程序固件是29288B，计算占FLASH空间大小=

29288/1024 = 29K,每页2K左右，大概占15页左右，

所以操作记录存储设定

+ 第30页存储RS485地址数值
+ 第31页存储风机运行数据
+ 第32页存储监控系统故障信息

**32位为1个字，16位为1个半字**

Flash的读操作：直接通过地址寻址即可

Flash的写操作：

+ STM32内部Flash每次必须写16位
+ 只能将1->0

因此在写Flash之前，要先将对应的页擦除，将所有字节变为0xFF 再进行写操作

# 测试结论

+ 对交流信号采样误差不大于0.5%
+ 电流信号不大于1.5%
+ 故障响应时间短

# 遇到的问题和怎么解决

# 找的是python代码。让他问问C和C++，没事，主要华为用的也是这些。用python防止调到测试。



## 代码与实际现象不符合

一般遇到的问题就是写的代码调试出来的结果跟理论不一样，首选确定硬件电路板没有问题，我之前有碰到过RTC元件焊反的情况，还有比如在采集的时候我发现采集电流效果不准，通过万用表发现实际有电路缺陷。

在电路没有问题的情况下，再调试软件代码。一般用串口打印或者配合debug，或者是网上搜寻相关线索。

比如之前碰到过看门狗放到了中断里面，这样的低级错误。

程序卡死，发现是在显示屏启动的时候有这个问题，再看LCD代码时发现要改变数据类型的时候，写数组数值时下标超出数组长度，导致对应地址被修改。

## 485 通讯速度

测试5从机，刚开始用115200，但是发现有丢帧的现象。

+ 通过降低上下拉电阻，降到了4.7Ω

+ 串口接收中断做的事情太多，我后来在接收中断里只转移缓冲数据，之后在主程序进行处理。

+ 485切换收发时，会基于MAX485有延时，所以可能第一个字节丢失了。

+ 串口是异步通信，但是我的定时器优先级比较高，会打断串口中断通信，导致数据丢失。115200的波特率,字之前的间隔只有几十微秒,STM32的串口是没有FIFO的.在接收过程中,被定时器中断超过这个时间,接收就会出错.串口中断的优先权要最高,并且要可以剥夺其他中断。

  > FIFO:一种连续存储数据的存储器

## 写Flash

nor flash,**32位为1个字，16位为1个半字**

Flash的读操作：直接通过地址寻址即可

由于Flash的写操作：

+ STM32内部Flash每次必须写16位
+ 只能将1->0

因此在写Flash之前，要先将对应的页擦除，将所有字节变为0xFF 再进行写操作

## 怎么解决

+ 自写log函数，串口打印输出到Sram
+ 串口调试
+ keil单步调试

# 后面测试怎么做的

嵌入式软件测试在４个阶段上进行，即模块测试、集成测试、系统测试、硬件／软件集成测试。

首先是进行功能测试，测试要求的功能是否正常。

接着是进行稳定性测试，这个项目要求是要有常开机不能关机的。



