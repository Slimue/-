**基于物联网的集群化智能门锁**



# 主要目的

为保障信息安全，提高信息传输过程的加密性，设计的一套集群化智能门锁

# 系统硬件设计

+ 核心控制器：STM32L476RG 

+ 高性能低功耗；核心具有FPU，支持所有单精度数据类型；能够实施一整套DSP指令和内存保护单元（MPU）
+ 主频：80MHZ
+ 嵌入式闪存
+ ADC：3个快速12位ADC
+ 操作电压：1.71V-3.6V
+ USB：3.3V专用电源输入
+ 5 URAT + 1ULP UART
+ ![image-20210904172730657](C:\Users\99375\AppData\Roaming\Typora\typora-user-images\image-20210904172730657.png)

## 无线通信子系统

### BLE模块

+ 恩智浦QN9080  通过π型匹配电路 获取最佳射频性能 无线近程通信

+ PCB印制天线 成本低 寿命长

+ BT TX 、BT RX两个管脚连接串口 BL RST

  ![image-20210904172327646](C:\Users\99375\AppData\Roaming\Typora\typora-user-images\image-20210904172327646.png)

### NB-IoT

BC28芯片 无线远程通信

通过USIM模块 SIM卡 访问NB-IoT模块

+ NB-TX:发送数据 

+ NB-RX:接受数据

+ NB-R1

  ![image-20210904172313233](C:\Users\99375\AppData\Roaming\Typora\typora-user-images\image-20210904172313233.png)

## 人机交互子系统

电阻按键：导电薄膜为高消耗品，使用感较差

电容式按键：非常薄，无明显凸起，物理磨损小，几乎不受外界温度影响，半永久性

采用电容式按键，检测电路基于RC振荡器，触摸时，相当于在固定电容上并一个触摸电容，电容发生改变，振荡器震荡频率发生改变，通过定时器检测触摸前后电容充放电周期变化，可以判断按键是否处于触摸状态。

![image-20210904171935102](C:\Users\99375\AppData\Roaming\Typora\typora-user-images\image-20210904171935102.png)

### 触摸控制芯片

TTP229芯片 快速自动校准 I2C协议通信

选用16键I²C通信，用户可以输入0-9数字密码，并通过触摸键盘唤醒核心MCU

![image-20210904172513365](C:\Users\99375\AppData\Roaming\Typora\typora-user-images\image-20210904172513365.png)

+ SDA：数据传输 高电平到低电平 开始传输 反之 停止
+ INT：初始化
+ SCL：时钟信号 开始传输时 先地址信号 R/W ACK应答信号 然后数据传输 应答信号
+ 半双工 可以双向传输 但某一时刻只能一个方向进行传输

### NFC模块



恩智浦PN532 NFC读卡芯片 方形天线利用电感耦合生成磁通，作为媒介传递信号

方形天线还可为手机虚拟卡提供电源，及时手机在关机状态下也可以实现开锁功能

![image-20210904201737300](C:\Users\99375\AppData\Roaming\Typora\typora-user-images\image-20210904201737300.png)

### 视频监控子系统

#### TFR-LCD显示屏 

320*280 分辨率 16位8080数据接口

显示屏驱动芯片 ILI9341 自带显存 不受MCU内存大小限制

+ CS：片选信号
+ RD：显示屏读取信号 （上升沿读取）
+ WR：显示屏写信号（上升沿写）
+ RS：命令/数据标志位（0命令 1 数据）
+ RST：复位
+ D【0：15】：16位双向数据线

#### OV5640摄像头

500w像素



# 系统软件设计

## 任务调度

8个任务，堆栈大小128，优先级，：

+ 开始任务------------------------------10
+ 电动机任务(转代表开锁)-----------3
+ NFC任务--------------------------------4
+ 键盘任务--------------------------------5
+ BLE任务---------------------------------6
+ NB-IoT任务----------------------------7
+ 人脸采集任务--------------------------8
+ 显示屏任务-----------------------------9

任务之间的信息传递和同步：

+ 信号量OSSemCreate()
+ 消息队列OSQCreate()
+ 接到信号量的时候，则任务拥有任务最高优先级

## 电子身份的鉴权认证(来者是谁)

比对流程如下：

+ (1) 密码匹配且不为一次性密码：传递信号量给人脸采集任务，拍摄来访者
  照片并通过 NB-IoT 模组上传到云端服务器。然后，云端执行人脸识别工作并将
  结果下发至设备终端。如果云端验证通过，核心主控将信号量发送给开锁任务，
  驱动电机开锁。否则，核心主控进入空闲任务。 输入密码---正确-->OV5640摄像头人脸数据采集-->NB-IoT模块传到云端---->人脸识别---识别通过-->开锁
+ (2) 采集的密码不匹配：若为失效密码，核心主控在更新本地密码存储后切
  换至空闲任务，无需上报到云端管理系统。
+ (3) 密码匹配且为一次性密码：挂起当前的电子身份采集任务，切换至电机
  驱动任务，更新本地密码存储，并生成日志。 输入密码--一次性密码正确-》不使用人脸采集---》开锁---》更新本地密码，生成日志---NB-IoT模组--》上传云端

### NFC是怎么比对的

开始--》初始化NFC模块UART接口--》发送指令，激活PN532芯片---》执行NFC的UID读取任务（寻卡，寻卡成功，读卡（读取UID序列））

### 按键密码是怎么认证的(刚才讲的触摸芯片K怎么发的)

*开头 #结尾 密码为6位 匹配 永久性 一次性 一次性限时 限时

## 无线通信的数据处理

整个结构分为两部分：

+ 智能门锁(下位机)下发通信
+ 云端管理系统(上位机)上行通信

### BLE通信怎么传输数据

SM4+CTR解密：与云端中存储的数据做对比 ：NB-IoT本地密码更新 同步云段时间 图像匹配结果  BLE应急开锁 无限升级 

SM4+CTR加密：人脸图像上传 门锁日志上传

### BLE通信怎么无线升级门锁的固件

+ UART ：与BLE通讯
+  定时器：中断中的递增计数判断是否更新
+  FLASH：擦除、读写应用程序

### NB-IOT怎么与云端通信

注意，BLE是连不上云端管理系统的，只是用带蓝牙的设备(手机、电脑)来与门锁通信，实现上述功能。

真正能与云端管理系统通信是靠NB-IOT

智能门锁(STM32芯片的UART模块) <==><==> NB-IOT <==>云端管理系统

----

NB-IOT与云端通信协议：CoAP协议

CoAP(这个要记住！)：（CON：需要被确认请求  NON：不需要被确认请求 ACK：消息应答 RST：复位）

---

讲讲AT指令，是物联网模块常用的指令：

UART发送AT指令(如下面的函数),NB-IOT接收到，就知道这是个AT函数，就读出来里面具体的指令和信息，按照这个AT函数的功能来执行.

代码上举例子，比如：

```c
UART_TRANSMIT('AT+NRB');
//UART_TRANSMI:芯片使用UART来进行发送括号里面的内容
//UART_TRANSMIT('AT+NRB');
//芯片使用UART来进行发送'AT+NRB'
//NB-IOT模块通过 TX线管脚接受到'AT_NRB'这一信息，就执行功能---模块重启
```

### 云端人脸识别

MTCNN+FACENET 

MTCNN 人脸检测 图片输入卷积神经网络 输出含人脸最终窗和五个面部关键点

FaceNet：用于人脸识别

# 遇到的问题

## 代码与实际现象不符合

一般遇到的问题就是写的代码调试出来的结果跟理论不一样，首选确定硬件电路板没有问题，因为PCB板子是我自己焊的，我之前有碰到过元件焊反的情况。

在电路没有问题的情况下，再调试软件代码。一般用串口打印或者配合debug，或者是网上搜寻相关线索。

+ 比如之前碰到过看门狗放到了中断里面，这样的低级错误。

+ 比如程序卡死，发现是在向云端发送数据启动的时候有这个问题，再看代码时发送前得改变数据类型，而且写数组数值时下标超出数组长度，导致对应地址被修改。

# 完成后测试怎么做的

嵌入式软件测试在４个阶段上进行，即模块测试、集成测试、系统测试、硬件／软件集成测试。

首先是进行功能测试，测试要求的功能是否正常。

接着是进行性能测试，包括硬件的功耗和算法的空间、时间的优化。

我这个门锁用4节干电池理论计算是可以用3年的时间，每次开锁是0.18mA。

# 你这个项目的创新点

+ 集群式门锁系统：包括人脸识别、NFC和触摸键盘密码等开锁技术。
+ 多保障开锁：在远程有云端系统控制，在近端有移动端的应急蓝牙连接开锁。
+ 支持物联网生态：后期通过接入小米或者华为生态，可以基于万物互联做一个互动。

 